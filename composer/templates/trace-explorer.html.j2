<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace Explorer</title>
    
    <!-- Prism.js for Solidity syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header and Navigation */
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .navigation {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .nav-button {
            background: #34495e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .nav-button:hover:not(:disabled) {
            background: #4a5f7f;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .step-indicator {
            margin-left: auto;
            font-size: 14px;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        
        .pane {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pane-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vfs-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .vfs-button:hover {
            background: #2980b9;
        }
        
        /* Generic Collapsible System */
        .collapsible {
            margin-bottom: 1.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .collapsible__trigger {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
            transition: background 0.2s;
            border: none;
            width: 100%;
            text-align: left;
            font-size: inherit;
            color: inherit;
        }
        
        .collapsible__trigger:hover {
            background: #e9ecef;
        }
        
        .collapsible__icon {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #495057;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        
        .collapsible[data-collapsible-state="collapsed"] .collapsible__icon {
            transform: rotate(-90deg);
        }
        
        .collapsible__title {
            flex: 1;
            font-weight: inherit;
        }
        
        .collapsible__content {
            padding: 1rem;
            background: white;
            max-height: 600px;
            overflow-y: auto;
            transition: all 0.2s ease;
        }
        
        .collapsible[data-collapsible-state="collapsed"] .collapsible__content {
            display: none;
        }
        
        /* Collapsible Variants */
        .collapsible--search {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }
        
        .collapsible--search .collapsible__trigger {
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .collapsible--search .collapsible__trigger:hover {
            background: #f0f0f0;
        }
        
        .collapsible--search .collapsible__title {
            font-weight: 600;
            color: #333;
        }
        
        .collapsible--violation .collapsible__trigger {
            background: transparent;
            border: none;
            padding: 0;
            font-size: 14px;
            font-weight: 500;
            margin-top: 0.75rem;
        }
        
        .collapsible--violation .collapsible__trigger:hover {
            background: transparent;
            opacity: 0.8;
        }
        
        .collapsible--violation .collapsible__content {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-left: 0;
            padding-right: 0;
        }
        
        /* Pre-formatted text blocks */
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .system-doc {
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* Chat/Message Styles */
        .messages-container, .search-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .message-bubble {
            /*background: #f0f2f5;*/
            border-radius: 12px;
            padding: 1rem;
            max-width: 85%;
            align-self: flex-start;
        }

        .message-bubble.text,
        .message-bubble.question-context,
        .message-bubble.question-code,
        .message-bubble.relaxation-explanation {
            background: #f0f2f5;
            border: 1px solid #788aa5;
        }

        .message-bubble.question-code {
            background: white;
            border: 1px solid #788aa5;
        }
        
        .message-bubble.thinking {
            background: #fff3cd;
            border: 1px solid #ffc107;
        }
        
        .message-bubble.thinking .message-text {
            font-style: italic;
            color: #856404;
        }
        
        .message-type-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #6c757d;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .tool-call {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            color: #155724;
            font-weight: 500;
        }
        
        /* VFS Modal Styles */
        .vfs-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s ease-in;
        }
        
        .vfs-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .vfs-modal-content {
            background: white;
            width: 90%;
            height: 80%;
            max-width: 1400px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .vfs-modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        
        .vfs-modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .vfs-close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .vfs-close-button:hover {
            background: #e9ecef;
        }
        
        .vfs-modal-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .vfs-file-list {
            width: 300px;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .vfs-file-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            transition: background 0.2s;
            word-break: break-all;
        }
        
        .vfs-file-item:hover {
            background: #e9ecef;
        }
        
        .vfs-file-item.active {
            background: #3498db;
            color: white;
        }
        
        .vfs-file-content {
            flex: 1;
            padding: 1.5rem;
            overflow: auto;
        }
        
        .vfs-file-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            color: #2c3e50;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }
        
        .vfs-file-code {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .vfs-empty-state {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 2rem;
        }
        
        /* Prover Step Styles */
        .prover-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }
        
        .prover-contract {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
        }
        
        .prover-contract:hover {
            color: #2980b9;
        }
        
        .prover-rule {
            font-weight: 600;
            color: #495057;
            margin-top: 0.5rem;
        }
        
        .prover-results {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .prover-result,
        .requirement-bubble {
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            border: 1px solid;
            transition: box-shadow 0.2s;
        }
        
        .prover-result.verified,
        .requirement-bubble.satisfied,
        .requirement-bubble.likely {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .prover-result.violated,
        .requirement-bubble.partial,
        .requirement-bubble.violated {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .prover-result.timeout,
        .requirement-bubble.ignored {
            background: #e2e3e5;
            border-color: #d6d8db;
            color: #383d41;
        }
        
        .prover-result.error {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .prover-result-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .prover-status-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .prover-rule-name,
        .requirement-text {
            font-weight: 600;
            flex: 1;
        }
        
        .prover-status-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        
        
        .prover-violation-content h1,
        .prover-violation-content h2,
        .prover-violation-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .prover-violation-content h1 { font-size: 1.5rem; }
        .prover-violation-content h2 { font-size: 1.3rem; }
        .prover-violation-content h3 { font-size: 1.1rem; }
        
        .prover-violation-content p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }
        
        .prover-violation-content code {
            background: rgba(0,0,0,0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .prover-violation-content pre {
            background: rgba(0,0,0,0.1);
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1rem 0;
        }
        
        .prover-violation-content ul,
        .prover-violation-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .message-bubble.human-response {
            align-self: flex-end;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
        }
        
        .message-bubble.search-query, .message-bubble.human-question {
            background: #e3f2fd;
            border: 1px solid #90caf9;
        }

        .message-bubble.search-query .message-type-label,
        .message-bubble.human-question .message-type-label {
            color: #1976d2;
        }

        div.llm-comments, div.summarization-container {
            padding: 1%;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        ul.result-files {
            list-style: "\1F5D2";
            margin-top: 1rem;
            margin-left: 1rem;
        }
        
        .message-bubble.search-query .message-text,
        .message-bubble.human-question .message-text {
            color: #0d47a1;
            font-weight: 500;
            line-height: 1.5;
        }

        .message-bubble.ai-analysis {
            background: #f3e5f5;
            border: 1px solid #ce93d8;
        }

        .message-bubble.ai-analysis .message-type-label {
            color: #7b1fa2;
        }

        .message-bubble.ai-analysis .message-text {
            color: #4a148c;
            font-weight: 500;
            line-height: 1.5;
        }
        
        .search-results {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-left: 2rem;
            align-self: flex-end;
            width: 85%;
        }
        
        .search-result-body {
            line-height: 1.6;
            color: #424242;
            margin-bottom: 0.75rem;
        }
        
        .search-result-similarity {
            font-size: 12px;
            color: #757575;
            font-style: italic;
            padding-top: 0.5rem;
            border-top: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .similarity-score {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-style: normal;
            font-weight: 500;
        }
        
        /* Put Step Styles */
        .put-updates {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .put-update {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .put-update-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .put-file-path {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .put-update-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .put-update-type {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .put-update-type.diff {
            background: #fff3e0;
            color: #e65100;
        }
        
        .put-view-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .put-view-toggle:hover {
            background: #5a6268;
        }
        
        .put-update-content {
            max-height: 600px;
            overflow: auto;
        }
        
        .diff-view {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .diff-line {
            padding: 0.25rem 0.5rem;
            white-space: pre;
            overflow-x: auto;
        }
        
        .diff-line.addition {
            background: #d4edda;
            color: #155724;
        }
        
        .diff-line.deletion {
            background: #f8d7da;
            color: #721c24;
        }
        
        .diff-line.context {
            background: white;
            color: #495057;
        }
        
        .diff-line.meta {
            background: #f0f0f0;
            color: #6c757d;
            font-weight: 600;
        }
        
        .diff-line.file-meta {
            background: #e9ecef;
            color: #495057;
            font-style: italic;
        }
        
        .put-file-view {
            padding: 1rem;
        }
        
        .put-file-view pre {
            margin: 0;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
        }
        
        /* Utility */
        .hidden {
            display: none;
        }
        
        /* Keyboard navigation hint */
        .keyboard-hint {
            font-size: 12px;
            color: #ffffff80;
            margin-left: 1rem;
        }

        /* Sidebar Menu Styles */
        .sidebar-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
            margin-right: 1rem;
        }

        .sidebar-toggle:hover {
            background: #34495e;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            z-index: 999;
            transition: left 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .sidebar-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .sidebar-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .step-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .step-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .step-item:hover {
            background: #f8f9fa;
        }

        .step-item.current {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            font-weight: 600;
            color: #1976d2;
        }

        .step-number {
            background: #6c757d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step-item.current .step-number {
            background: #2196f3;
        }

        .step-title {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }

        /* Initial Requirements Styles */
        .initial-requirements {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .initial-requirement-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem 1rem;
            border-left: 4px solid #6c757d;
            transition: border-color 0.2s;
        }

        .initial-requirement-item:hover {
            border-left-color: #495057;
        }

        .initial-requirement-number {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 14px;
        }

        .initial-requirement-text {
            line-height: 1.6;
            color: #333;
        }

        /* VFS Commands Styles */
        .vfs-commands-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .vfs-command-item {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .vfs-thought {
            background: #fff9c4;
            border: 1px solid #fdd835;
            padding: 1rem 1.5rem;
            font-style: italic;
            color: #6d4c41;
            line-height: 1.6;
            border-radius: 8px;
            position: relative;
        }

        .vfs-thought:before {
            content: "üí≠";
            position: absolute;
            left: 0.5rem;
            top: 0.5rem;
            font-size: 1.2rem;
        }

        .vfs-thought .vfs-thought-content {
            margin-left: 1.5rem;
        }

        .vfs-cmd {
            background: #1e1e1e;
            color: #ffffff;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            border-radius: 8px;
        }

        .vfs-cmd-header {
            background: #2d2d2d;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 12px;
            color: #b0b0b0;
        }

        .vfs-cmd-prompt {
            background: #1e1e1e;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .vfs-cmd-prompt-symbol {
            color: #4fc3f7;
            font-weight: bold;
            flex-shrink: 0;
        }

        .vfs-cmd-text {
            color: #ffffff;
            flex: 1;
            word-break: break-all;
        }

        .vfs-cmd-output {
            background: #1e1e1e;
            padding: 0 1rem 1rem 1rem;
            white-space: pre-wrap;
            color: #e0e0e0;
            line-height: 1.4;
            border-top: 1px solid #404040;
            max-height: 400px;
            overflow-y: auto;
        }

        .vfs-cmd-output.solidity-highlight {
            padding: 1rem;
        }

        .vfs-cmd-output.solidity-highlight pre {
            margin: 0;
            padding: 1rem;
            border-radius: 4px;
        }

        /* Prover TODO List Styles */
        .prover-todo-section {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .prover-todo-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #e65100;
        }

        .prover-todo-icon {
            font-size: 1.2rem;
        }

        .prover-todo-note {
            font-size: 0.9rem;
            color: #bf360c;
            font-style: italic;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: rgba(255, 183, 77, 0.2);
            border-radius: 4px;
        }

        .prover-todo-content {
            color: #e65100;
            line-height: 1.6;
        }

        .prover-todo-content h1,
        .prover-todo-content h2,
        .prover-todo-content h3,
        .prover-todo-content h4,
        .prover-todo-content h5,
        .prover-todo-content h6 {
            color: #e65100;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .prover-todo-content ul,
        .prover-todo-content ol {
            margin-left: 1rem;
            margin-bottom: 1rem;
        }

        .prover-todo-content li {
            margin-bottom: 0.5rem;
        }

        .prover-todo-content code {
            background: rgba(230, 81, 0, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #bf360c;
        }

        .prover-todo-content pre {
            background: rgba(230, 81, 0, 0.1);
            border: 1px solid #ffb74d;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <!-- Header with Navigation -->
    <div class="header">
        <h1>Trace Explorer</h1>
        <div class="navigation">
            <button id="sidebarToggle" class="sidebar-toggle">
                ‚ò∞
            </button>
            <button id="prevBtn" class="nav-button">
                ‚Üê Previous
            </button>
            <button id="nextBtn" class="nav-button">
                Next ‚Üí
            </button>
            <span class="keyboard-hint">Use arrow keys to navigate</span>
            <div class="step-indicator">
                Step <span id="currentStep">1</span> of <span id="totalSteps">1</span>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Steps</div>
            <button id="sidebarClose" class="sidebar-close">√ó</button>
        </div>
        <div class="sidebar-content">
            <ul id="stepList" class="step-list">
                <!-- Steps will be populated by JavaScript -->
            </ul>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="main-content">
        <div id="paneContainer"></div>
    </div>
    
    <!-- VFS Modal -->
    <div id="vfsModal" class="vfs-modal">
        <div class="vfs-modal-content">
            <div class="vfs-modal-header">
                <div class="vfs-modal-title">Virtual File System - Snapshot <span id="vfsSnapshotNumber"></span></div>
                <button class="vfs-close-button" data-vfs-close>√ó</button>
            </div>
            <div class="vfs-modal-body">
                <div class="vfs-file-list" id="vfsFileList"></div>
                <div class="vfs-file-content" id="vfsFileContent">
                    <div class="vfs-empty-state">Select a file to view its contents</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Templates -->
    <!-- Initial Step Template -->
    <template id="initial-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Initial Configuration</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            
            <div class="collapsible" data-collapsible-state="expanded">
                <div class="collapsible__trigger" data-collapsible-trigger>
                    <span class="collapsible__icon"></span>
                    <span class="collapsible__title">Initial Specification</span>
                </div>
                <div class="collapsible__content">
                    <pre class="spec-content"><code class="language-cvl"></code></pre>
                </div>
            </div>
            
            <div class="collapsible" data-collapsible-state="expanded">
                <div class="collapsible__trigger" data-collapsible-trigger>
                    <span class="collapsible__icon"></span>
                    <span class="collapsible__title">Initial Interface</span>
                </div>
                <div class="collapsible__content">
                    <pre class="interface-content"><code class="language-solidity"></code></pre>
                </div>
            </div>
            
            <div class="collapsible" data-collapsible-state="expanded">
                <div class="collapsible__trigger" data-collapsible-trigger>
                    <span class="collapsible__icon"></span>
                    <span class="collapsible__title">System Documentation</span>
                </div>
                <div class="collapsible__content">
                    <div class="system-doc"></div>
                </div>
            </div>
            
            <div class="collapsible requirements-section" data-collapsible-state="expanded">
                <div class="collapsible__trigger" data-collapsible-trigger>
                    <span class="collapsible__icon"></span>
                    <span class="collapsible__title">Initial Requirements</span>
                </div>
                <div class="collapsible__content">
                    <div class="initial-requirements"></div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- AI Step Template -->
    <template id="ai-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>AI Execution Step</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            <div class="messages-container"></div>
            <div class="tool-call"></div>
        </div>
    </template>
    
    <!-- Message Bubble Template -->
    <template id="message-bubble-template">
        <div class="message-bubble">
            <div class="message-type-label"></div>
            <div class="message-text"></div>
        </div>
    </template>
    
    <!-- Prover Step Template -->
    <template id="prover-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Formal Verification</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            
            <div class="prover-info">
                <div>Contract: <span class="prover-contract" data-contract-file></span></div>
                <div class="prover-rule"></div>
            </div>
            
            <div class="prover-todo-section hidden">
                <div class="prover-todo-header">
                    <span class="prover-todo-icon">üìã</span>
                    <span>Action Items</span>
                </div>
                <div class="prover-todo-note">
                    The following TODO list summarizes actions needed to address the verification failures below.
                </div>
                <div class="prover-todo-content"></div>
            </div>
            
            <div class="prover-results"></div>
        </div>
    </template>
    
    <!-- Prover Result Template -->
    <template id="prover-result-template">
        <div class="prover-result">
            <div class="prover-result-header">
                <span class="prover-status-icon"></span>
                <span class="prover-rule-name"></span>
                <span class="prover-status-label"></span>
            </div>
            <div class="prover-violation-section"></div>
        </div>
    </template>

    <template id="spec-change-template">
        <div class="pane">
            <div class="pane-header">
                <span>Spec Change Proposal</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            <div class="messages-container"></div>
        </div>
    </template>
    
    <!-- Search Step Template -->
    <template id="search-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>RAG Database Search</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            
            <div class="search-container">
                <!--<div class="search-query">
                    <div class="search-query-label">Search Query</div>
                    <div class="search-query-text"></div>
                </div>-->
                
                <div class="search-results"></div>
            </div>
        </div>
    </template>

    <template id="result-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Generation Complete</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>

            <div class="result-block">
                <h2>LLM Commentary</h2>
                <div class="llm-comments"></div>
                <hr>
                <h2>Referenced Files</h2>
                <ul class="result-files">
                </ul>
            </div>
        </div>
    </template>
    
    <!-- Search Result Template -->
    <template id="search-result-template">
        <div class="collapsible collapsible--search" data-collapsible-state="expanded">
            <div class="collapsible__trigger" data-collapsible-trigger>
                <span class="collapsible__icon"></span>
                <span class="collapsible__title search-result-title"></span>
            </div>
            <div class="collapsible__content">
                <div class="search-result-body"></div>
                <div class="search-result-similarity">
                    Similarity Score: <span class="similarity-score"></span>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Put Step Template -->
    <template id="put-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>VFS Updates</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            
            <div class="put-updates"></div>
        </div>
    </template>
    
    <!-- Put Update Template -->
    <template id="put-update-template">
        <div class="put-update">
            <div class="put-update-header">
                <span class="put-file-path"></span>
                <div class="put-update-actions">
                    <span class="put-update-type"></span>
                    <button class="put-view-toggle hidden" data-toggle-view>Show Full File</button>
                </div>
            </div>
            <div class="put-update-content"></div>
        </div>
    </template>

    <template id="human-question-template">
        <div class="pane">
            <div class="pane-header">
                <span>Human Question</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            <div class="messages-container"></div>
        </div>
    </template>

    <!-- VFS Step Template -->
    <template id="vfs-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>VFS Interactions</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            <div class="vfs-commands-container"></div>
        </div>
    </template>

    <!-- VFS Thought Template -->
    <template id="vfs-thought-template">
        <div class="vfs-thought">
            <div class="vfs-thought-content"></div>
        </div>
    </template>

    <!-- VFS Command Template -->
    <template id="vfs-cmd-template">
        <div class="vfs-cmd">
            <div class="vfs-cmd-header">‚óè ‚óè ‚óè Terminal</div>
            <div class="vfs-cmd-prompt">
                <span class="vfs-cmd-prompt-symbol">></span>
                <span class="vfs-cmd-text"></span>
            </div>
            <div class="vfs-cmd-output"></div>
        </div>
    </template>

    <!-- Summarization Step Template -->
    <template id="summarization-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Context Summarization</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            üîÑ Task state has been summarized due to context length. The state summary is as follows.
            <div class="summarization-container"></div>
        </div>
    </template>

    <!-- Relaxation Step Template -->
    <template id="relaxation-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Requirement Relaxation Request</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            <div class="messages-container"></div>
        </div>
    </template>

    <!-- Requirements Step Template -->
    <template id="requirements-step-template">
        <div class="pane">
            <div class="pane-header">
                <span>Requirements Evaluation</span>
                <button class="vfs-button" data-vfs-open>View VFS</button>
            </div>
            
            <div class="requirements-results"></div>
        </div>
    </template>

    <!-- Requirement Bubble Template -->
    <template id="requirement-bubble-template">
        <div class="requirement-bubble">
            <div class="prover-result-header">
                <span class="prover-status-icon"></span>
                <span class="requirement-text"></span>
                <span class="prover-status-label"></span>
            </div>
            <div class="requirement-commentary-section"></div>
        </div>
    </template>

    <!-- Requirement Commentary Template -->
    <template id="requirement-commentary-template">
        <div class="collapsible collapsible--violation" data-collapsible-state="collapsed">
            <div class="collapsible__trigger" data-collapsible-trigger>
                <span class="collapsible__icon"></span>
                <span class="collapsible__title">View Commentary</span>
            </div>
            <div class="collapsible__content">
                <div class="prover-violation-content commentary-text"></div>
            </div>
        </div>
    </template>

    <template id="vfs-file-pane-template">
        <div class="vfs-file-header"></div>
        <div class="vfs-file-code"></div>
    </template>
    
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-solidity.min.js"></script>
    
    <!-- CVL syntax highlighting -->
    <script>
{% include 'prism-cvl.js' %}
    </script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
    
    <script>
        // Sample VFS and steps data - to be replaced with your actual data
        const fs = {{ fs_dump }};
        const steps = {{ steps_dump }};
        
        // Global state
        let currentStepIndex = 0;
        let currentVFSSnapshot = null;
        let selectedFile = null;
        let stepTitles = [];
        
        // Initialize the application
        function init() {
            generateStepTitles();
            populateSidebar();
            attachEventListeners();
            
            // Read initial step from URL hash
            currentStepIndex = parseURLHash();
            
            updateStepIndicator();
            updateSidebarHighlight();
            renderCurrentStep();
            updateNavigationButtons();
        }
        
        // Generate step titles based on step types
        function generateStepTitles() {
            stepTitles = steps.map(step => {
                switch(step.type) {
                    case 'initial':
                        return 'Initial Configuration';
                    case 'ai':
                        return 'AI Execution Step';
                    case 'prover':
                        return 'Formal Verification';
                    case 'search':
                        return 'RAG Database Search';
                    case 'put_file':
                        return 'VFS Updates';
                    case 'question':
                        return 'Human Question';
                    case 'proposal':
                        return 'Spec Change Proposal';
                    case 'result':
                        return 'Generation Complete';
                    case 'vfs':
                        return 'VFS Interactions';
                    case 'summarization':
                        return 'Context Summarization';
                    case 'relaxation':
                        return 'Requirement Relaxation Request';
                    case 'judge':
                        return 'Requirements Evaluation';
                    default:
                        return `Unknown Step (${step.type})`;
                }
            });
        }
        
        // Populate the sidebar with step list
        function populateSidebar() {
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = '';
            
            stepTitles.forEach((title, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'step-item';
                if (index === currentStepIndex) {
                    listItem.classList.add('current');
                }
                
                listItem.innerHTML = `
                    <div class="step-number">${index + 1}</div>
                    <div class="step-title">${title}</div>
                `;
                
                listItem.addEventListener('click', () => {
                    navigateToStep(index);
                    closeSidebar();
                });
                
                stepList.appendChild(listItem);
            });
        }
        
        // Update sidebar current step highlight
        function updateSidebarHighlight() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                item.classList.toggle('current', index === currentStepIndex);
            });
        }
        
        // Sidebar toggle functions
        function openSidebar() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
        }
        
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
        }
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }
        
        // Navigate to specific step
        function navigateToStep(index) {
            if (index >= 0 && index < steps.length) {
                currentStepIndex = index;
                updateStepIndicator();
                updateSidebarHighlight();
                renderCurrentStep();
                updateNavigationButtons();
                updateURL();
            }
        }
        
        // URL hash support
        function updateURL() {
            if (currentStepIndex > 0) {
                window.location.hash = `#step=${currentStepIndex + 1}`;
            } else {
                window.location.hash = '';
            }
        }
        
        function parseURLHash() {
            const hash = window.location.hash;
            if (hash.startsWith('#step=')) {
                const stepNumber = parseInt(hash.substring(6), 10);
                if (!isNaN(stepNumber) && stepNumber >= 1 && stepNumber <= steps.length) {
                    return stepNumber - 1; // Convert to 0-based index
                }
            }
            return 0; // Default to first step
        }
        
        function handleHashChange() {
            const newStepIndex = parseURLHash();
            if (newStepIndex !== currentStepIndex) {
                navigateToStep(newStepIndex);
            }
        }
        
        // Generic collapsible system
        function initCollapsibles() {
            document.addEventListener('click', (e) => {
                const trigger = e.target.closest('[data-collapsible-trigger]');
                if (trigger) {
                    toggleCollapsible(trigger.closest('.collapsible'));
                }
            });
        }
        
        function toggleCollapsible(collapsibleElement) {
            const currentState = collapsibleElement.dataset.collapsibleState || 'expanded';
            const newState = currentState === 'expanded' ? 'collapsed' : 'expanded';
            collapsibleElement.dataset.collapsibleState = newState;
            
            // Emit custom event for additional handling
            collapsibleElement.dispatchEvent(new CustomEvent('collapsible:toggle', {
                detail: { state: newState, element: collapsibleElement }
            }));
        }
        
        function expandCollapsible(element) {
            element.dataset.collapsibleState = 'expanded';
        }
        
        function collapseCollapsible(element) {
            element.dataset.collapsibleState = 'collapsed';
        }
        
        // Attach all event listeners
        function attachEventListeners() {
            // Navigation buttons
            document.getElementById('prevBtn').addEventListener('click', () => {
                navigateStep(-1);
            });
            
            document.getElementById('nextBtn').addEventListener('click', () => {
                navigateStep(1);
            });
            
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // Hash change listener
            window.addEventListener('hashchange', handleHashChange);
            
            // Initialize unified collapsible system
            initCollapsibles();
            
            // Event delegation for dynamically created elements
            document.getElementById('paneContainer').addEventListener('click', (e) => {
                // VFS open button
                const vfsOpenButton = e.target.closest('[data-vfs-open]');
                if (vfsOpenButton) {
                    openVFSModal();
                }
                
                // Contract file link in prover step
                const contractFileLink = e.target.closest('[data-contract-file]');
                if (contractFileLink) {
                    const filePath = contractFileLink.dataset.contractFile;
                    openVFSModalWithFile(filePath);
                }
                
                // Put view toggle
                const putToggle = e.target.closest('[data-toggle-view]');
                if (putToggle) {
                    togglePutView(putToggle);
                }
            });
            
            // VFS Modal close
            document.getElementById('vfsModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('vfsModal') || 
                    e.target.closest('[data-vfs-close]')) {
                    closeVFSModal();
                }
            });
            
            // VFS file selection
            document.getElementById('vfsFileList').addEventListener('click', (e) => {
                const fileItem = e.target.closest('.vfs-file-item');
                if (fileItem) {
                    selectVFSFile(fileItem.dataset.path);
                }
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    navigateStep(-1);
                } else if (e.key === 'ArrowRight') {
                    navigateStep(1);
                } else if (e.key === 'Escape') {
                    if (document.getElementById('vfsModal').classList.contains('active')) {
                        closeVFSModal();
                    } else if (document.getElementById('sidebar').classList.contains('active')) {
                        closeSidebar();
                    }
                }
            });
        }
        
        // Build cumulative VFS view up to a snapshot
        function buildVFSView(snapshotIndex) {
            const vfsView = {};
            
            // Build cumulative view
            for (let i = 0; i <= snapshotIndex && i < fs.length; i++) {
                Object.assign(vfsView, fs[i]);
            }
            
            return vfsView;
        }
        
        // VFS Modal functions
        function openVFSModal() {
            const step = steps[currentStepIndex];
            currentVFSSnapshot = step.vfs_snapshot;
            
            const modal = document.getElementById('vfsModal');
            modal.classList.add('active');
            
            // Update snapshot number
            document.getElementById('vfsSnapshotNumber').textContent = currentVFSSnapshot;
            
            // Build and display file list
            const vfsView = buildVFSView(currentVFSSnapshot);
            const fileList = document.getElementById('vfsFileList');
            fileList.innerHTML = '';
            
            // Sort paths for better display
            const paths = Object.keys(vfsView).sort();
            
            paths.forEach(path => {
                const fileItem = document.createElement('div');
                fileItem.className = 'vfs-file-item';
                fileItem.dataset.path = path;
                fileItem.textContent = path;
                fileList.appendChild(fileItem);
            });
            
            // Clear previous selection
            selectedFile = null;
            document.getElementById('vfsFileContent').innerHTML = 
                '<div class="vfs-empty-state">Select a file to view its contents</div>';
        }
        
        function closeVFSModal() {
            document.getElementById('vfsModal').classList.remove('active');
            currentVFSSnapshot = null;
            selectedFile = null;
        }
        
        function selectVFSFile(path) {
            selectedFile = path;
            const vfsView = buildVFSView(currentVFSSnapshot);
            const content = vfsView[path];
            
            // Update active state in file list
            document.querySelectorAll('.vfs-file-item').forEach(item => {
                item.classList.toggle('active', item.dataset.path === path);
            });
            
            // Display file content
            const contentContainer = document.getElementById('vfsFileContent');
            
            const fileTemplate = document.getElementById("vfs-file-pane-template");

            const fileInst = fileTemplate.content.cloneNode(true);
            fileInst.querySelector(".vfs-file-header").innerText = path;
            const codeContents = fileInst.querySelector(".vfs-file-code");
            renderCodeSnippet(
                codeContents, path, content
            );
            contentContainer.replaceChildren(fileInst);
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Render the current step
        function renderCurrentStep() {
            const container = document.getElementById('paneContainer');
            const step = steps[currentStepIndex];
            
            // Clear existing content
            container.innerHTML = '';
            
            // Render based on step type
            switch(step.type) {
                case 'initial':
                    renderInitialStep(step, container);
                    break;
                case 'ai':
                    renderAIStep(step, container);
                    break;
                case 'prover':
                    renderProverStep(step, container);
                    break;
                case 'search':
                    renderSearchStep(step, container);
                    break;
                case 'put_file':
                    renderPutStep(step, container);
                    break;
                case 'question':
                    renderHumanQuestionStep(step, container);
                    break;
                case 'proposal':
                    renderProposalStep(step, container);
                    break;
                case 'vfs':
                    renderVFSStep(step, container);
                    break;
                case 'summarization':
                    renderSummarizationStep(step, container);
                    break;
                case "result":
                    renderResultStep(step, container);
                    break;
                case 'judge':
                    renderRequirementsStep(step, container);
                    break;
                case 'relaxation':
                    renderRelaxationStep(step, container);
                    break;
                default:
                    console.warn(`Unknown step type: ${step.type}`);
            }
        }

        // Render Summarization Step
        function renderSummarizationStep(step, container) {
            const template = document.getElementById('summarization-step-template');
            const clone = template.content.cloneNode(true);
            
            // Render the markdown summary content
            const contentDiv = clone.querySelector('.summarization-container');
            contentDiv.innerHTML = renderMarkdown(step.summary_md);
            
            container.appendChild(clone);
        }

        // Render VFS Step
        function renderVFSStep(step, container) {
            const template = document.getElementById('vfs-step-template');
            const clone = template.content.cloneNode(true);
            
            const commandsContainer = clone.querySelector('.vfs-commands-container');
            
            // Render each command in the VFS event
            step.commands.forEach(command => {
                if (command.type === 'thought') {
                    const thoughtElement = renderVFSThought(command.msg);
                    commandsContainer.appendChild(thoughtElement);
                } else if (command.type === 'cmd') {
                    const cmdElement = renderVFSCommand(command.cmd, command.stdout);
                    commandsContainer.appendChild(cmdElement);
                }
            });
            
            container.appendChild(clone);
        }
        
        // Render VFS thought block using template
        function renderVFSThought(message) {
            const template = document.getElementById('vfs-thought-template');
            const clone = template.content.cloneNode(true);
            
            clone.querySelector('.vfs-thought-content').textContent = message;
            
            return clone;
        }
        
        // Render VFS command block using template
        function renderVFSCommand(cmd, stdout) {
            const template = document.getElementById('vfs-cmd-template');
            const clone = template.content.cloneNode(true);
            
            // Set command text
            clone.querySelector('.vfs-cmd-text').textContent = cmd;
            
            // Set output with syntax highlighting for .sol files in cat commands
            const outputDiv = clone.querySelector('.vfs-cmd-output');
            
            if (cmd.trim().startsWith('cat ') && cmd.includes('.sol')) {
                outputDiv.classList.add('solidity-highlight');
                outputDiv.innerHTML = `<pre><code class="language-solidity">${escapeHtml(stdout)}</code></pre>`;
                // Apply syntax highlighting after DOM insertion
                setTimeout(() => Prism.highlightAllUnder(outputDiv), 0);
            } else {
                outputDiv.textContent = stdout;
            }
            
            return clone;
        }

        function renderResultStep(step, container) {
            const template = document.getElementById("result-step-template").content.cloneNode(true);
            template.querySelector(".llm-comments").innerHTML = renderMarkdown(step.comments);
            const resultList = template.querySelector(".result-files")
            step.files.forEach((f) => {
                const l = document.createElement("li");
                l.innerHTML = `
                    <span class="prover-contract" data-contract-file="${f}">${f}</span>
                `;
                resultList.appendChild(l);
            })
            container.appendChild(template);
        }

        function renderProposalStep(step, container) {
            const template = document.getElementById("spec-change-template").content.cloneNode(true);
            const messageContainer = template.querySelector(".messages-container");
            messageContainer.appendChild(
                renderMessageBubbleFn("Spec Diff", "question-code", (d) =>  {
                    d.appendChild(renderDiffContent(step.proposed_diff, "spec-diff-code"))
                })
            )

            messageContainer.appendChild(
                renderMessageBubble(
                    step.explanation,
                    "Explanation",
                    "text"
                )
            );

            messageContainer.appendChild(
                renderMessageBubble(
                    step.human_response,
                    "Human Response",
                    "human-response"
                )
            )
            container.appendChild(template);
        }

        function renderHumanQuestionStep(step, container) {
            const template = document.getElementById("human-question-template").content.cloneNode(true);
            const messageContainer = template.querySelector(".messages-container");

            const contextBubble = renderMessageBubble(step.context, "Context", "text");
            messageContainer.appendChild(contextBubble);

            if(step.code) {
                messageContainer.appendChild(renderMessageBubbleFn("Code Reference", "question-code", (d) => {
                    d.appendChild(renderSolidityCode(step.code));
                }));
            }

            messageContainer.appendChild(renderMessageBubble(
                step.query,
                "Question",
                "human-question"
            ));

            messageContainer.appendChild(renderMessageBubble(
                step.answer,
                "Response",
                "human-response"
            ));
            container.appendChild(template);
        }
        
        // Render Initial Step
        function renderInitialStep(step, container) {
            const template = document.getElementById('initial-step-template');
            const clone = template.content.cloneNode(true);
            
            // Fill in the spec
            clone.querySelector('.spec-content code').textContent = step.spec;
            
            // Fill in the interface with syntax highlighting
            const interfaceCode = clone.querySelector('.interface-content code');
            interfaceCode.textContent = step.interface;
            
            // Fill in the system doc
            clone.querySelector('.system-doc').textContent = step.system_doc;
            
            // Handle requirements if present
            const requirementsSection = clone.querySelector('.requirements-section');
            const initialRequirements = clone.querySelector('.initial-requirements');
            
            if (step.reqs && step.reqs.length > 0) {
                // Render each requirement
                step.reqs.forEach((requirement, index) => {
                    const reqItem = document.createElement('div');
                    reqItem.className = 'initial-requirement-item';
                    
                    reqItem.innerHTML = `
                        <div class="initial-requirement-number">Requirement ${index + 1}</div>
                        <div class="initial-requirement-text">${escapeHtml(requirement)}</div>
                    `;
                    
                    initialRequirements.appendChild(reqItem);
                });
            } else {
                // Hide the requirements section if no requirements
                requirementsSection.style.display = 'none';
            }
            
            container.appendChild(clone);
            
            // Trigger Prism syntax highlighting
            Prism.highlightAll();
        }

        function renderSolidityCode(code) {
            const pre = document.createElement("pre");
            pre.innerHTML = `<code class="language-solidity">${escapeHtml(code)}</code>`;
            Prism.highlightAllUnder(pre);
            return pre;
        }

        function renderMessageBubbleFn(type, typeClass, cb) {
            const messageClone = document.getElementById('message-bubble-template').content.cloneNode(true);
            const bubble = messageClone.querySelector('.message-bubble');
            messageClone.querySelector(".message-type-label").textContent = type;
            if(typeClass) {
                bubble.classList.add(typeClass);
            }
            cb(messageClone.querySelector(".message-text"));
            return messageClone;
        }

        function renderMessageBubble(content, type, typeClass) {
            return renderMessageBubbleFn(type, typeClass, (d) => { d.textContent = content });
        }
        
        // Render AI Step
        function renderAIStep(step, container) {
            const template = document.getElementById('ai-step-template');
            const clone = template.content.cloneNode(true);
            
            const messagesContainer = clone.querySelector('.messages-container');
            const messageTemplate = document.getElementById('message-bubble-template');
            
            // Render each message
            step.messages.forEach(message => {
                const tyClass = message.type === "thinking" ? "thinking" : "text";
                const typeText = message.type === "thinking" ? "Thinking" : "Response";
                const messageBubble = renderMessageBubble(message.text, typeText, tyClass);
                messagesContainer.appendChild(messageBubble);
            });
            
            // Add tool call
            const toolCall = clone.querySelector('.tool-call');
            toolCall.textContent = `Tool called: ${step.tool}`;
            
            container.appendChild(clone);
        }
        
        // Render Prover Step
        function renderProverStep(step, container) {
            const template = document.getElementById('prover-step-template');
            const clone = template.content.cloneNode(true);
            
            // Set contract file
            const contractFile = clone.querySelector('[data-contract-file]');
            contractFile.textContent = step.contract_file;
            contractFile.dataset.contractFile = step.contract_file;
            
            // Set rule
            const ruleElement = clone.querySelector('.prover-rule');
            ruleElement.textContent = step.rule ? `Rule: ${step.rule}` : 'Rule: All rules';
            
            // Handle optional TODO list
            const todoSection = clone.querySelector('.prover-todo-section');
            if (step.todo_list) {
                todoSection.classList.remove('hidden');
                const todoContent = clone.querySelector('.prover-todo-content');
                todoContent.innerHTML = renderMarkdown(step.todo_list);
            }
            
            // Render results
            const resultsContainer = clone.querySelector('.prover-results');
            const resultTemplate = document.getElementById('prover-result-template');
            
            step.results.forEach(result => {
                const resultClone = resultTemplate.content.cloneNode(true);
                const resultDiv = resultClone.querySelector('.prover-result');
                
                // Set status class
                resultDiv.classList.add(result.status.toLowerCase());
                
                // Set icon and status label
                const icon = resultClone.querySelector('.prover-status-icon');
                const statusLabel = resultClone.querySelector('.prover-status-label');
                
                switch(result.status) {
                    case 'VERIFIED':
                        icon.textContent = '‚úì';
                        break;
                    case 'VIOLATED':
                        icon.textContent = '‚úó';
                        break;
                    case 'TIMEOUT':
                        icon.textContent = '‚è±';
                        break;
                    case 'ERROR':
                        icon.textContent = '‚ö†';
                        break;
                }
                
                statusLabel.textContent = result.status;
                
                // Set rule name
                resultClone.querySelector('.prover-rule-name').textContent = result.rule;
                
                // Handle violation analysis if present
                if (result.status === 'VIOLATED' && result.analysis) {
                    const violationSection = resultClone.querySelector('.prover-violation-section');
                    
                    // Use marked.js to parse markdown with syntax highlighting support
                    const parsedMarkdown = renderMarkdown(result.analysis);
                    
                    violationSection.innerHTML = `
                        <div class="collapsible collapsible--violation" data-collapsible-state="collapsed">
                            <div class="collapsible__trigger" data-collapsible-trigger>
                                <span class="collapsible__icon"></span>
                                <span class="collapsible__title">View Violation Analysis</span>
                            </div>
                            <div class="collapsible__content">
                                ${parsedMarkdown}
                            </div>
                        </div>
                    `;
                }
                
                resultsContainer.appendChild(resultClone);
            });
            
            container.appendChild(clone);
        }

        function renderMarkdown(mdString) {
            return marked.parse(mdString, {
                gfm: true,
                breaks: true,
                highlight: function(code, lang) {
                    if (lang === 'solidity' && Prism.languages.solidity) {
                        return Prism.highlight(code, Prism.languages.solidity, 'solidity');
                    }
                    return code;
                }
            })
        }

        // Render Relaxation Step
        function renderRelaxationStep(step, container) {
            const template = document.getElementById('relaxation-step-template');
            const clone = template.content.cloneNode(true);
            const messageContainer = clone.querySelector('.messages-container');

            // Show the requirement being questioned
            messageContainer.appendChild(renderMessageBubble(
                step.requirement,
                "Requirement",
                "text"
            ));

            // Show the context
            messageContainer.appendChild(renderMessageBubble(
                step.context,
                "Context",
                "relaxation-explanation"
            ));

            // Show the judgment
            messageContainer.appendChild(renderMessageBubble(
                `Judgment: ${step.judgment}`,
                "AI Judgment",
                "ai-analysis"
            ));

            // Show the explanation
            messageContainer.appendChild(renderMessageBubble(
                step.explanation,
                "Explanation",
                "relaxation-explanation"
            ));

            // Show human response
            messageContainer.appendChild(renderMessageBubble(
                step.response,
                "Human Response",
                "human-response"
            ));

            container.appendChild(clone);
        }

        // Render Requirements Step
        function renderRequirementsStep(step, container) {
            const template = document.getElementById('requirements-step-template');
            const clone = template.content.cloneNode(true);
            
            const resultsContainer = clone.querySelector('.requirements-results');
            const bubbleTemplate = document.getElementById('requirement-bubble-template');
            const commentaryTemplate = document.getElementById('requirement-commentary-template');
            
            step.evaluation.forEach(requirement => {
                const bubbleClone = bubbleTemplate.content.cloneNode(true);
                const bubbleDiv = bubbleClone.querySelector('.requirement-bubble');
                
                // Set status class based on judgment
                const judgment = requirement.judgment.toLowerCase();
                bubbleDiv.classList.add(judgment);
                
                // Set icon and status label
                const icon = bubbleClone.querySelector('.prover-status-icon');
                const statusLabel = bubbleClone.querySelector('.prover-status-label');
                
                switch(judgment) {
                    case 'satisfied':
                    case 'likely':
                        icon.textContent = '‚úì';
                        break;
                    case 'partial':
                        icon.textContent = '‚ö†';
                        break;
                    case 'violated':
                        icon.textContent = '‚úó';
                        break;
                    case 'ignored':
                        icon.textContent = '‚äò';
                        break;
                }
                
                statusLabel.textContent = requirement.judgment;
                
                // Set requirement text
                bubbleClone.querySelector('.requirement-text').textContent = requirement.require_text;
                
                // Handle commentary if present
                if (requirement.commentary) {
                    const commentarySection = bubbleClone.querySelector('.requirement-commentary-section');
                    const commentaryClone = commentaryTemplate.content.cloneNode(true);
                    
                    // Set the commentary text
                    commentaryClone.querySelector('.commentary-text').textContent = requirement.commentary;
                    
                    commentarySection.appendChild(commentaryClone);
                }
                
                resultsContainer.appendChild(bubbleClone);
            });
            
            container.appendChild(clone);
        }
        
        // Render Search Step
        function renderSearchStep(step, container) {
            const template = document.getElementById('search-step-template');
            const clone = template.content.cloneNode(true);

            const questionBubble = renderMessageBubble(
                step.query,
                "Search Query",
                "search-query"
            );

            clone.querySelector(".search-container").prepend(questionBubble);
            
            // Render results
            const resultsContainer = clone.querySelector('.search-results');
            const resultTemplate = document.getElementById('search-result-template');
            
            step.results.forEach((result, index) => {
                const resultClone = resultTemplate.content.cloneNode(true);
                
                // Set header/title
                resultClone.querySelector('.search-result-title').textContent = result.header;
                
                // Set content
                resultClone.querySelector('.search-result-body').textContent = result.content;
                
                // Set similarity score
                const similarityScore = resultClone.querySelector('.similarity-score');
                similarityScore.textContent = result.similarity.toFixed(2);
                
                // Start with first result expanded, others collapsed
                if (index > 0) {
                    const icon = resultClone.querySelector('.collapsible__icon');
                    const content = resultClone.querySelector('.collapsible__content');
                    icon.classList.add('collapsed');
                    content.classList.add('collapsed');
                }
                
                resultsContainer.appendChild(resultClone);
            });
            
            container.appendChild(clone);
        }
        
        // Render Put Step
        function renderPutStep(step, container) {
            const template = document.getElementById('put-step-template');
            const clone = template.content.cloneNode(true);
            
            const updatesContainer = clone.querySelector('.put-updates');
            const updateTemplate = document.getElementById('put-update-template');
            
            step.updates.forEach(update => {
                const updateClone = updateTemplate.content.cloneNode(true);
                
                // Set file path
                updateClone.querySelector('.put-file-path').textContent = update.path;
                
                // Set type badge
                const typeBadge = updateClone.querySelector('.put-update-type');
                typeBadge.textContent = update.type === 'fresh' ? 'NEW' : 'MODIFIED';
                if (update.type === 'diff') {
                    typeBadge.classList.add('diff');
                }
                
                const contentDiv = updateClone.querySelector('.put-update-content');
                const toggleButton = updateClone.querySelector('[data-toggle-view]');
                
                if (update.type === 'fresh') {
                    // For fresh files, show the full content
                    toggleButton.classList.add('hidden');
                    renderPutFileContent(contentDiv, update.path, update.contents);
                } else if (update.type === 'diff') {
                    // For diff files, show diff by default with toggle option
                    toggleButton.classList.remove('hidden');
                    toggleButton.dataset.filePath = update.path;
                    toggleButton.dataset.fileContents = update.contents;
                    
                    // Initially show diff view
                    renderPutDiffContent(contentDiv, update.diff_lines);
                }
                
                updatesContainer.appendChild(updateClone);
            });
            
            container.appendChild(clone);
        }

        function renderDiffContent(diffLines, idClass) {
            const diffView = document.createElement('div');
            diffView.classList.add("diff-view");
            diffView.classList.add(idClass);
            
            diffLines.forEach(line => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'diff-line';
                lineDiv.textContent = line;
                
                if (line.startsWith('+++') || line.startsWith('---')) {
                    lineDiv.classList.add('file-meta');
                } else if (line.startsWith('@@')) {
                    lineDiv.classList.add('meta');
                } else if (line.startsWith('+')) {
                    lineDiv.classList.add('addition');
                } else if (line.startsWith('-')) {
                    lineDiv.classList.add('deletion');
                } else {
                    lineDiv.classList.add('context');
                }
                
                diffView.appendChild(lineDiv);
            });
            return diffView;
        }
        
        // Render diff content with colored lines
        function renderPutDiffContent(container, diffLines) {
            const diffView = renderDiffContent(diffLines, "put-diff-view");
            container.appendChild(diffView);
        }

        function renderCodeSnippet(
            container, path, contents
        ) {
            const preElem = document.createElement("pre");
            var doHighlight = false;
            function getCode(lang) {
                const codeElem = document.createElement("code");
                codeElem.classList.add(`language-${lang}`);
                codeElem.textContent = contents;
                doHighlight = true;
                return codeElem;
            }
            if(path.endsWith(".sol")) {
                preElem.appendChild(getCode("solidity"));
            } else if(path.endsWith(".spec")) {
                preElem.appendChild(getCode("cvl"));
            } else {
                preElem.innerText = contents;
            }
            container.appendChild(preElem);
            if(doHighlight) {
                Prism.highlightAllUnder(container);  
            }
        }
        
        // Render file content with syntax highlighting
        function renderPutFileContent(container, path, contents) {
            const fileView = document.createElement('div');
            fileView.className = 'put-file-view';
            renderCodeSnippet(
                fileView, path, contents
            );
            
            container.appendChild(fileView);
        }
        
        // Toggle between diff and full file view
        function togglePutView(button) {
            const contentDiv = button.closest('.put-update').querySelector('.put-update-content');
            const isShowingDiff = button.textContent === 'Show Full File';
            
            // Clear current content
            contentDiv.innerHTML = '';
            
            if (isShowingDiff) {
                // Switch to full file view
                button.textContent = 'Show Diff';
                const path = button.dataset.filePath;
                const contents = button.dataset.fileContents;
                renderPutFileContent(contentDiv, path, contents);
            } else {
                // Switch back to diff view
                button.textContent = 'Show Full File';
                // Need to get diff_lines from the original step data
                const stepIndex = currentStepIndex;
                const step = steps[stepIndex];
                const update = step.updates.find(u => u.path === button.dataset.filePath);
                if (update && update.diff_lines) {
                    renderPutDiffContent(contentDiv, update.diff_lines);
                }
            }
        }
        
        
        // Open VFS Modal with specific file selected
        function openVFSModalWithFile(filePath) {
            openVFSModal();
            // After modal is open, select the file
            setTimeout(() => {
                selectVFSFile(filePath);
            }, 100);
        }
        
        
        // Navigation functions
        function navigateStep(direction) {
            const newIndex = currentStepIndex + direction;
            navigateToStep(newIndex);
        }
        
        function updateStepIndicator() {
            document.getElementById('currentStep').textContent = currentStepIndex + 1;
            document.getElementById('totalSteps').textContent = steps.length;
        }
        
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentStepIndex === 0;
            nextBtn.disabled = currentStepIndex === steps.length - 1;
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>